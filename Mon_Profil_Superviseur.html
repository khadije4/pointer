<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Superviseur - Gestion de Pointage</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* [Keep all your existing CSS styles] */
        /* Add this new style for document links */
        .document-link {
            color: #00a86b;
            text-decoration: underline;
            cursor: pointer;
        }
        .document-link:hover {
            color: #008f5a;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="welcome">
            <h1>Tableau de Bord Superviseur</h1>
            <p>Bienvenue, {{ session.user_name }}</p>
        </div>
        <div class="user-info">
            <i class="fas fa-user-shield"></i>
            <span>Superviseur</span>
        </div>
        <a href="{{ url_for('logout') }}" class="logout-btn">
            <i class="fas fa-sign-out-alt"></i> Déconnexion
        </a>
    </div>

    <div class="navigation">
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">
                <i class="fas fa-chart-pie"></i> Tableau de Bord
            </button>
            <button class="nav-tab" onclick="showTab('students')">
                <i class="fas fa-users"></i> Gestion Élèves
            </button>
            <button class="nav-tab" onclick="showTab('professors')">
                <i class="fas fa-chalkboard-teacher"></i> Gestion Professeurs
            </button>
            <button class="nav-tab" onclick="showTab('justifications')">
                <i class="fas fa-file-signature"></i> Justificatifs
            </button>
        </div>
    </div>

    <!-- Dashboard Tab -->
    <div id="dashboard" class="tab-content active">
        <div class="notification">
            <i class="fas fa-info-circle"></i>
            <div class="notification-content">
                <h4>Information</h4>
                <p>Consultez les statistiques globales, validez les justificatifs et surveillez les alertes d'absences pour l'ensemble de l'établissement.</p>
            </div>
        </div>

        <div class="dashboard-grid">
            <!-- Monitoring Global Card -->
            <div class="card">
                <h2><i class="fas fa-chart-pie"></i> Monitoring Global</h2>
                <table>
                    <thead><tr><th>Classe</th><th>Taux d'absence</th><th>Présence</th></tr></thead>
                    <tbody id="attendance-stats">
                        {% for class, stats in class_stats.items() %}
                        <tr>
                            <td>{{ class }}</td>
                            <td>{{ stats.absence }}%</td>
                            <td>{{ stats.presence }}%</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div style="margin-top:18px;">
                    <canvas id="absChart" width="220" height="100"></canvas>
                </div>
            </div>
            
            <!-- Statistiques Professeurs Card -->
            <div class="card">
                <h2><i class="fas fa-chalkboard-teacher"></i> Statistiques Professeurs</h2>
                <table>
                    <thead><tr><th>Professeur</th><th>Taux d'absence élèves</th></tr></thead>
                    <tbody id="professor-stats">
                        {% for prof in professor_stats %}
                        <tr>
                            <td>{{ prof.nom }} {{ prof.prenom }}</td>
                            <td>{{ prof.absence_rate }}%</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Statistiques Élèves Card -->
            <div class="card">
                <h2><i class="fas fa-users"></i> Statistiques Élèves</h2>
                <table>
                    <thead><tr><th>Élève</th><th>Classe</th><th>Taux d'absence</th></tr></thead>
                    <tbody id="student-stats">
                        {% for student in absent_students %}
                        <tr>
                            <td>{{ student.nom }} {{ student.prenom }}</td>
                            <td>{{ student.classe }}</td>
                            <td>{{ student.absence_rate }}%</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="dashboard-grid" style="grid-template-columns: 2fr 1fr;">
            <!-- Notifications -->
            <div class="card">
                <h2><i class="fas fa-bell"></i> Notifications</h2>
                {% for student in absent_students if student.absence_rate > 10 %}
                <div class="notif">
                    Alerte : Taux d'absence élevé ({{ student.absence_rate }}%) pour {{ student.prenom }} {{ student.nom }} ({{ student.classe }})
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Students Management Tab -->
    <div id="students" class="tab-content">
        <div class="management-section">
            <div class="section-header">
                <h2><i class="fas fa-users"></i> Gestion des Élèves</h2>
                <button class="btn" onclick="toggleAddForm('student')">
                    <i class="fas fa-plus"></i> Ajouter un Élève
                </button>
            </div>

            <div id="add-student-form" class="add-form">
                <h3>Ajouter un nouvel élève</h3>
                <form id="student-form" onsubmit="return submitStudentForm(event)">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Matricule *</label>
                            <input type="text" name="matricule" required>
                        </div>
                        <div class="form-group">
                            <label>NNI *</label>
                            <input type="text" name="nni" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Prénom *</label>
                            <input type="text" name="prenom" required>
                        </div>
                        <div class="form-group">
                            <label>Nom *</label>
                            <input type="text" name="nom" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Classe *</label>
                            <select name="classe" required>
                                <option value="">Sélectionner une classe</option>
                                <option value="DAII-L2">DAII-L2</option>
                                <option value="MAIGE-L2">MAIGE-L2</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Téléphone</label>
                            <input type="tel" name="telephone">
                        </div>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn">
                            <i class="fas fa-save"></i> Enregistrer l'élève
                        </button>
                        <button type="button" class="btn danger" onclick="toggleAddForm('student')">
                            <i class="fas fa-times"></i> Annuler
                        </button>
                    </div>
                </form>
            </div>

            <input type="text" class="search-box" placeholder="Rechercher un élève..." onkeyup="searchTable('students-table', this.value)">
            
            <table id="students-table">
                <thead>
                    <tr>
                        <th>Matricule</th>
                        <th>Prénom</th>
                        <th>Nom</th>
                        <th>Classe</th>
                        <th>Téléphone</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="students-list">
                    {% for student in students %}
                    <tr data-id="{{ student.id }}">
                        <td>{{ student.matricule }}</td>
                        <td>{{ student.prenom }}</td>
                        <td>{{ student.nom }}</td>
                        <td>{{ student.classe }}</td>
                        <td>{{ student.telephone or 'N/A' }}</td>
                        <td>
                            <button class="btn warning" onclick="editStudent({{ student.id }})">
                                <i class="fas fa-edit"></i> Modifier
                            </button>
                            <button class="btn danger" onclick="deleteStudent({{ student.id }})">
                                <i class="fas fa-trash"></i> Supprimer
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Professors Management Tab -->
    <div id="professors" class="tab-content">
        <div class="management-section">
            <div class="section-header">
                <h2><i class="fas fa-chalkboard-teacher"></i> Gestion des Professeurs</h2>
                <button class="btn" onclick="toggleAddForm('professor')">
                    <i class="fas fa-plus"></i> Ajouter un Professeur
                </button>
            </div>

            <div id="add-professor-form" class="add-form">
                <h3>Ajouter un nouveau professeur</h3>
                <form id="professor-form" onsubmit="return submitProfessorForm(event)">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Matricule *</label>
                            <input type="text" name="matricule" required>
                        </div>
                        <div class="form-group">
                            <label>NNI *</label>
                            <input type="text" name="nni" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Prénom *</label>
                            <input type="text" name="prenom" required>
                        </div>
                        <div class="form-group">
                            <label>Nom *</label>
                            <input type="text" name="nom" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" name="email">
                        </div>
                        <div class="form-group">
                            <label>Téléphone</label>
                            <input type="tel" name="telephone">
                        </div>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn">
                            <i class="fas fa-save"></i> Enregistrer le professeur
                        </button>
                        <button type="button" class="btn danger" onclick="toggleAddForm('professor')">
                            <i class="fas fa-times"></i> Annuler
                        </button>
                    </div>
                </form>
            </div>

            <input type="text" class="search-box" placeholder="Rechercher un professeur..." onkeyup="searchTable('professors-table', this.value)">
            
            <table id="professors-table">
                <thead>
                    <tr>
                        <th>Matricule</th>
                        <th>Prénom</th>
                        <th>Nom</th>
                        <th>Email</th>
                        <th>Téléphone</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="professors-list">
                    {% for professor in professors %}
                    <tr data-id="{{ professor.id }}">
                        <td>{{ professor.matricule }}</td>
                        <td>{{ professor.prenom }}</td>
                        <td>{{ professor.nom }}</td>
                        <td>{{ professor.email or 'N/A' }}</td>
                        <td>{{ professor.telephone or 'N/A' }}</td>
                        <td>
                            <button class="btn warning" onclick="editProfessor({{ professor.id }})">
                                <i class="fas fa-edit"></i> Modifier
                            </button>
                            <button class="btn danger" onclick="deleteProfessor({{ professor.id }})">
                                <i class="fas fa-trash"></i> Supprimer
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Justifications Tab -->
    <div id="justifications" class="tab-content">
        <div class="management-section">
            <h2><i class="fas fa-file-signature"></i> Validation des Justificatifs</h2>
            <table id="justif-table">
                <thead>
                    <tr>
                        <th>Élève</th>
                        <th>Date</th>
                        <th>Cours</th>
                        <th>Motif</th>
                        <th>Document</th>
                        <th>Statut</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for justification in pending_justifications %}
                    <tr data-id="{{ justification.id }}">
                        <td>{{ justification.eleve_prenom }} {{ justification.eleve_nom }}</td>
                        <td>{{ justification.date_presence }}</td>
                        <td>{{ justification.nom_cours }}</td>
                        <td>
                            {{ justification.reason_type }}
                            {% if justification.custom_reason %}: {{ justification.custom_reason }}{% endif %}
                            {% if justification.description %}<br><small>{{ justification.description }}</small>{% endif %}
                        </td>
                        <td>
                            {% if justification.document_path %}
                            <a href="{{ url_for('static', filename='uploads/justifications/' + justification.document_path) }}" 
                               class="document-link" target="_blank">
                                <i class="fas fa-file-pdf"></i> Voir document
                            </a>
                            {% else %}
                            Aucun document
                            {% endif %}
                        </td>
                        <td class="status-cell status-pending">En attente</td>
                        <td>
                            <button class="btn" onclick="validateJustif({{ justification.id }}, this)">
                                <i class="fas fa-check"></i> Valider
                            </button>
                            <button class="btn danger" onclick="rejectJustif({{ justification.id }}, this)">
                                <i class="fas fa-times"></i> Rejeter
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" style="text-align: center;">Aucun justificatif en attente</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Tab Management
        function showTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => tab.classList.remove('active'));
            
            // Remove active class from all tabs
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Form Management
        function toggleAddForm(type) {
            const form = document.getElementById(`add-${type}-form`);
            form.classList.toggle('show');
        }

        // Student Management
        async function submitStudentForm(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            try {
                const response = await fetch('/api/students', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': formData.get('csrf_token')
                    },
                    body: JSON.stringify(Object.fromEntries(formData))
                });
                
                if (!response.ok) throw new Error(await response.text());
                
                const newStudent = await response.json();
                addStudentToTable(newStudent);
                form.reset();
                toggleAddForm('student');
                alert('Élève ajouté avec succès!');
            } catch (error) {
                console.error('Error:', error);
                alert('Erreur lors de l\'ajout de l\'élève: ' + error.message);
            }
        }
        
        function addStudentToTable(student) {
            const tbody = document.getElementById('students-list');
            const row = document.createElement('tr');
            row.setAttribute('data-id', student.id);
            
            row.innerHTML = `
                <td>${student.matricule}</td>
                <td>${student.prenom}</td>
                <td>${student.nom}</td>
                <td>${student.classe}</td>
                <td>${student.telephone || 'N/A'}</td>
                <td>
                    <button class="btn warning" onclick="editStudent(${student.id})">
                        <i class="fas fa-edit"></i> Modifier
                    </button>
                    <button class="btn danger" onclick="deleteStudent(${student.id})">
                        <i class="fas fa-trash"></i> Supprimer
                    </button>
                </td>
            `;
            
            tbody.appendChild(row);
        }
        
        async function editStudent(studentId) {
            try {
                // Fetch student data
                const response = await fetch(`/api/student/${studentId}`);
                if (!response.ok) throw new Error(await response.text());
                
                const student = await response.json();
                
                // Create modal with student data
                createModal(
                    `Modifier l'élève ${student.prenom} ${student.nom}`,
                    [
                        { label: 'Matricule', name: 'matricule', value: student.matricule, type: 'text' },
                        { label: 'NNI', name: 'nni', value: student.nni, type: 'text' },
                        { label: 'Prénom', name: 'prenom', value: student.prenom, type: 'text' },
                        { label: 'Nom', name: 'nom', value: student.nom, type: 'text' },
                        { 
                            label: 'Classe', 
                            name: 'classe', 
                            value: student.classe, 
                            type: 'select',
                            options: ['DAII-L2', 'MAIGE-L2']
                        },
                        { label: 'Téléphone', name: 'telephone', value: student.telephone || '', type: 'tel' }
                    ],
                    async (data) => {
                        try {
                            const response = await fetch(`/api/students/${studentId}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': '{{ csrf_token() }}'
                                },
                                body: JSON.stringify(data)
                            });
                            
                            if (!response.ok) throw new Error(await response.text());
                            
                            // Update table row
                            const row = document.querySelector(`tr[data-id="${studentId}"]`);
                            if (row) {
                                row.cells[0].textContent = data.matricule;
                                row.cells[1].textContent = data.prenom;
                                row.cells[2].textContent = data.nom;
                                row.cells[3].textContent = data.classe;
                                row.cells[4].textContent = data.telephone || 'N/A';
                            }
                            
                            alert('Élève modifié avec succès!');
                        } catch (error) {
                            console.error('Error:', error);
                            alert('Erreur lors de la modification: ' + error.message);
                        }
                    }
                );
            } catch (error) {
                console.error('Error:', error);
                alert('Erreur lors du chargement des données: ' + error.message);
            }
        }
        
        async function deleteStudent(studentId) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer cet élève?')) return;
            
            try {
                const response = await fetch(`/api/students/${studentId}`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token() }}'
                    }
                });
                
                if (!response.ok) throw new Error(await response.text());
                
                const row = document.querySelector(`tr[data-id="${studentId}"]`);
                if (row) row.remove();
                
                alert('Élève supprimé avec succès!');
            } catch (error) {
                console.error('Error:', error);
                alert('Erreur lors de la suppression: ' + error.message);
            }
        }

        // Professor Management
        async function submitProfessorForm(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            try {
                const response = await fetch('/api/professors', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': formData.get('csrf_token')
                    },
                    body: JSON.stringify(Object.fromEntries(formData))
                });
                
                if (!response.ok) throw new Error(await response.text());
                
                const newProfessor = await response.json();
                addProfessorToTable(newProfessor);
                form.reset();
                toggleAddForm('professor');
                alert('Professeur ajouté avec succès!');
            } catch (error) {
                console.error('Error:', error);
                alert('Erreur lors de l\'ajout du professeur: ' + error.message);
            }
        }
        
        function addProfessorToTable(professor) {
            const tbody = document.getElementById('professors-list');
            const row = document.createElement('tr');
            row.setAttribute('data-id', professor.id);
            
            row.innerHTML = `
                <td>${professor.matricule}</td>
                <td>${professor.prenom}</td>
                <td>${professor.nom}</td>
                <td>${professor.email || 'N/A'}</td>
                <td>${professor.telephone || 'N/A'}</td>
                <td>
                    <button class="btn warning" onclick="editProfessor(${professor.id})">
                        <i class="fas fa-edit"></i> Modifier
                    </button>
                    <button class="btn danger" onclick="deleteProfessor(${professor.id})">
                        <i class="fas fa-trash"></i> Supprimer
                    </button>
                </td>
            `;
            
            tbody.appendChild(row);
        }
        
        async function editProfessor(professorId) {
            try {
                // Fetch professor data
                const response = await fetch(`/api/professor/${professorId}`);
                if (!response.ok) throw new Error(await response.text());
                
                const professor = await response.json();
                
                // Create modal with professor data
                createModal(
                    `Modifier le professeur ${professor.prenom} ${professor.nom}`,
                    [
                        { label: 'Matricule', name: 'matricule', value: professor.matricule, type: 'text' },
                        { label: 'NNI', name: 'nni', value: professor.nni, type: 'text' },
                        { label: 'Prénom', name: 'prenom', value: professor.prenom, type: 'text' },
                        { label: 'Nom', name: 'nom', value: professor.nom, type: 'text' },
                        { label: 'Email', name: 'email', value: professor.email || '', type: 'email' },
                        { label: 'Téléphone', name: 'telephone', value: professor.telephone || '', type: 'tel' }
                    ],
                    async (data) => {
                        try {
                            const response = await fetch(`/api/professors/${professorId}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': '{{ csrf_token() }}'
                                },
                                body: JSON.stringify(data)
                            });
                            
                            if (!response.ok) throw new Error(await response.text());
                            
                            // Update table row
                            const row = document.querySelector(`tr[data-id="${professorId}"]`);
                            if (row) {
                                row.cells[0].textContent = data.matricule;
                                row.cells[1].textContent = data.prenom;
                                row.cells[2].textContent = data.nom;
                                row.cells[3].textContent = data.email || 'N/A';
                                row.cells[4].textContent = data.telephone || 'N/A';
                            }
                            
                            alert('Professeur modifié avec succès!');
                        } catch (error) {
                            console.error('Error:', error);
                            alert('Erreur lors de la modification: ' + error.message);
                        }
                    }
                );
            } catch (error) {
                console.error('Error:', error);
                alert('Erreur lors du chargement des données: ' + error.message);
            }
        }
        
        async function deleteProfessor(professorId) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer ce professeur?')) return;
            
            try {
                const response = await fetch(`/api/professors/${professorId}`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token() }}'
                    }
                });
                
                if (!response.ok) throw new Error(await response.text());
                
                const row = document.querySelector(`tr[data-id="${professorId}"]`);
                if (row) row.remove();
                
                alert('Professeur supprimé avec succès!');
            } catch (error) {
                console.error('Error:', error);
                alert('Erreur lors de la suppression: ' + error.message);
            }
        }

        // Search functionality
        function searchTable(tableId, searchValue) {
            const table = document.getElementById(tableId);
            const tbody = table.querySelector('tbody');
            const rows = tbody.querySelectorAll('tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchValue.toLowerCase())) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Justification Management
        async function validateJustif(justifId, btn) {
            const row = btn.closest('tr');
            const comment = row.querySelector('.comment-box')?.value || '';
            
            try {
                const response = await fetch(`/approve_justification/${justifId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: JSON.stringify({ comment })
                });
                
                if (!response.ok) throw new Error(await response.text());
                
                const result = await response.json();
                if (result.success) {
                    const statusCell = row.querySelector('.status-cell');
                    statusCell.textContent = 'Validé';
                    statusCell.className = 'status-cell status-approved';
                    row.querySelector('td:last-child').innerHTML = '<span style="color: #27ae60;">Validé</span>';
                    alert('Justificatif validé avec succès!');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Erreur lors de la validation: ' + error.message);
            }
        }

        async function rejectJustif(justifId, btn) {
            const row = btn.closest('tr');
            const comment = row.querySelector('.comment-box')?.value || '';
            
            if (!comment.trim()) {
                alert('Veuillez ajouter un commentaire pour le rejet.');
                return;
            }
            
            try {
                const response = await fetch(`/reject_justification/${justifId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: JSON.stringify({ comment })
                });
                
                if (!response.ok) throw new Error(await response.text());
                
                const result = await response.json();
                if (result.success) {
                    const statusCell = row.querySelector('.status-cell');
                    statusCell.textContent = 'Rejeté';
                    statusCell.className = 'status-cell status-rejected';
                    row.querySelector('td:last-child').innerHTML = '<span style="color: #e74c3c;">Rejeté</span>';
                    alert('Justificatif rejeté avec succès!');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Erreur lors du rejet: ' + error.message);
            }
        }

        // Initialize chart when page loads
        document.addEventListener('DOMContentLoaded', function() {
            const ctx = document.getElementById('absChart').getContext('2d');
            
            // Get data from Flask template
            const classes = {{ class_stats.keys()|list|tojson }};
            const absenceRates = {{ class_stats.values()|map(attribute='absence')|list|tojson }};
            const presenceRates = {{ class_stats.values()|map(attribute='presence')|list|tojson }};
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: classes,
                    datasets: [
                        {
                            label: 'Taux d\'absence',
                            data: absenceRates,
                            backgroundColor: '#e74c3c',
                            borderRadius: 4,
                        },
                        {
                            label: 'Taux de présence',
                            data: presenceRates,
                            backgroundColor: '#27ae60',
                            borderRadius: 4,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Pourcentage (%)'
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    elements: {
                        bar: {
                            borderWidth: 1,
                            borderColor: 'rgba(255,255,255,0.8)'
                        }
                    }
                }
            });
        });

        // Enhanced modal for editing (alternative to prompts)
        function createModal(title, fields, onSave) {
            // Remove existing modal if any
            const existingModal = document.getElementById('edit-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const modal = document.createElement('div');
            modal.id = 'edit-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 15px;
                width: 90%;
                max-width: 500px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            `;
            
            let formHTML = `<h3 style="color: #00a86b; margin-bottom: 20px;">${title}</h3>
                           <form id="modal-form">
                           <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">`;
            
            fields.forEach(field => {
                if (field.type === 'select') {
                    formHTML += `
                        <div class="form-group">
                            <label>${field.label}</label>
                            <select name="${field.name}" required>
                                ${field.options.map(option => 
                                    `<option value="${option}" ${option === field.value ? 'selected' : ''}>${option}</option>`
                                ).join('')}
                            </select>
                        </div>
                    `;
                } else {
                    formHTML += `
                        <div class="form-group">
                            <label>${field.label}</label>
                            <input type="${field.type || 'text'}" name="${field.name}" value="${field.value || ''}" required>
                        </div>
                    `;
                }
            });
            
            formHTML += `
                <div class="form-group" style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn danger" onclick="closeModal()" style="margin-right: 10px;">
                        <i class="fas fa-times"></i> Annuler
                    </button>
                    <button type="submit" class="btn">
                        <i class="fas fa-save"></i> Enregistrer
                    </button>
                </div>
            </form>`;
            
            modalContent.innerHTML = formHTML;
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Handle form submission
            document.getElementById('modal-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                const data = {};
                for (let [key, value] of formData.entries()) {
                    if (key !== 'csrf_token') {
                        data[key] = value;
                    }
                }
                onSave(data);
                closeModal();
            });
            
            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeModal();
                }
            });
        }
        
        function closeModal() {
            const modal = document.getElementById('edit-modal');
            if (modal) {
                modal.remove();
            }
        }

        // Auto-refresh statistics every 5 minutes
        setInterval(async () => {
            try {
                const response = await fetch('/supervisor_dashboard');
                if (response.ok) {
                    // In a real app, you would update the DOM with new data
                    console.log('Statistics updated');
                }
            } catch (error) {
                console.error('Error refreshing data:', error);
            }
        }, 300000);
    </script>
</body>
</html>